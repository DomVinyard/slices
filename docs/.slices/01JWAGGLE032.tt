---
tt:
  v: "1"
  id: 01JWAGGLE032
  created_at: "2024-01-23T14:00:00Z"
  title: "Session: Pack Walk Design"
  summary: "Agent helping design multi-dog ride coordination"
  kind: context
  body:
    type: conversation
    conversation:
      participants: ["agent", "sarah", "jake"]
      agent_id: "waggle-dev-agent"
      session_id: "sess_pack_walk_001"
      format: "markdown"
      includes_tool_calls: true
  contract:
    purpose: "Design session for pack walks feature"
    exclude: ["unrelated conversations"]
    format: "Conversation with context and decisions"
    write: append
  links:
    - rel: parent
      to: 01JWAGGLE030
      label: "Current Sprint"
    - rel: references
      to: 01JWAGGLE020
      label: "Ride Matching"
    - rel: references
      to: 01JWAGGLE024
      label: "Dog Profile Schema"
---

# Session: Pack Walk Design

## Context

Multi-dog households keep requesting the ability to take all their dogs on rides together. Currently, each dog needs a separate ride request, which is expensive and inefficient.

---

**Sarah:** We need to figure out pack walks. 40% of our users have multiple dogs, and they're all complaining.

**Agent:** I can help design this. Let me understand the current state.

[Tool: search "multi-dog" in codebase]

Looking at the ride matching code, I see rides are strictly 1:1 (one dog, one driver). The key challenges I see:

1. **Request coordination** - How do multiple dogs join a single ride?
2. **Vehicle capacity** - Need to check all dogs fit
3. **Destination agreement** - What if dogs want different places?
4. **Treat budget** - Combined or separate?
5. **Wag scoring** - How to attribute satisfaction per dog?

**Jake:** The vehicle capacity one is critical. We had a user try to stuff three Great Danes in a Prius.

**Agent:** Let me propose a flow:

### Pack Ride Request Flow

```
1. Dog A boops collar
2. System detects other Waggle dogs in household
3. Companion app shows "Pack Ride?" prompt to human
4. Human confirms which dogs are joining
5. Each joining dog gets "Join ride?" collar prompt
6. Dog confirms with boop + bark
7. Matching finds vehicle that fits all dogs
8. Single ride, combined pricing
```

**Sarah:** I like it, but what about the collar-to-collar communication? Right now collars don't talk to each other.

**Agent:** Good point. Options:

**Option A: Phone as Hub**
- All collar-to-collar communication goes through phone
- Pros: No hardware change, works now
- Cons: All dogs must be in BLE range of phone

**Option B: Direct Collar Mesh**
- Collars form BLE mesh network
- Pros: Works even if phone is far
- Cons: Firmware update, battery impact, 3-month timeline

**Option C: Cloud Coordination**
- Each collar talks to cloud independently
- Pros: No collar changes
- Cons: Requires internet, slight delay

**Jake:** Option A for MVP, Option B for v2?

**Agent:** Agreed. For MVP:

```typescript
interface PackRideRequest {
  primaryDogId: string;      // Who initiated
  joiningDogIds: string[];   // Who's coming along
  destination: Destination;
  vehicleRequirements: {
    minCapacity: number;     // Sum of dog sizes
    separatorRequired: boolean;  // If any dogs are "selective"
  };
}
```

**Sarah:** What about conflicting destinations? Luna wants the park, Buster wants Charlie's house.

**Agent:** Three options:

1. **Primary dog decides** - Whoever booped first picks
2. **Majority vote** - Most popular destination wins
3. **Sequential stops** - Visit closest destination first, then continue

I'd recommend #1 for MVP with #3 as a premium feature.

**Jake:** Makes sense. What about the wag scoring problem? We can't tell whose tail is wagging if they're all in the car together.

**Agent:** This is the hard one. The accelerometers will pick up each other's movements. 

[Tool: read tail-wag/analyzer.py]

Current approach uses lateral acceleration. In a pack ride, we'd get interference.

**Ideas:**

1. **Frequency isolation** - Each dog has a characteristic wag frequency
2. **Collar orientation** - Use gyroscope to determine which way collar is facing
3. **Skip individual scoring** - Just report aggregate "pack happiness"

**Sarah:** I'd go with #3 for MVP. We can say "pack happiness: 8.5" instead of individual scores.

**Agent:** Agreed. Let me draft the data model changes:

```prisma
model Ride {
  // ... existing fields
  
  packRide      Boolean   @default(false)
  primaryDogId  String?
  
  dogs          RideDog[]  // Many-to-many for pack rides
}

model RideDog {
  ride          Ride      @relation(...)
  rideId        String
  dog           Dog       @relation(...)
  dogId         String
  
  joinedAt      DateTime
  wagScoreAtArrival Float?  // Null for pack rides in MVP
  
  @@id([rideId, dogId])
}
```

**Jake:** This looks good. I'll start on the backend tomorrow.

---

## Decisions Made

1. Use phone as hub for collar coordination (MVP)
2. Primary dog picks destination
3. Aggregate wag score for pack rides
4. Vehicle capacity check based on sum of dog sizes

## Follow-up Items

- [ ] Jake: Implement PackRideRequest in matching service
- [ ] Tom: Firmware update for "join ride" collar prompt
- [ ] Lisa: Research frequency-based wag isolation for v2
